# This dockerfile generates an Zabbix packages for s390x
# Build arguments:
#   VERSION: Required. Used to label the image.
#   BUILD_DATE: Required. Used to label the image. Should be in the form 'yyyy-mm-ddThh:mm:ssZ', i.e. a date-time from https://tools.ietf.org/html/rfc3339. The timestamp must be in UTC.
#   VCS_REF: short VCS hash
FROM ubuntu:18.04 AS ubuntu-18.04-build

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y software-properties-common build-essential equivs wget gcc libldap2-dev libcurl4-openssl-dev zlib1g-dev
RUN wget -P /tmp https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1%2Bubuntu18.04_all.deb && dpkg -i /tmp/zabbix-release_7.0-1+ubuntu18.04_all.deb
RUN wget -P /tmp https://go.dev/dl/go1.22.4.linux-s390x.tar.gz && tar -C /usr/local -xzf /tmp/go1.22.4.linux-s390x.tar.gz
ENV PATH=PATH=$PATH:/usr/local/go/bin

RUN apt update -y
RUN mkdir /tmp/zabbix
RUN cd /tmp/zabbix && apt source zabbix && apt build-dep -y zabbix && cd zabbix-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-postgresql && cd zabbix-agent2-plugin-postgresql-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-ember-plus && cd zabbix-agent2-plugin-ember-plus-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mongodb && cd zabbix-agent2-plugin-mongodb-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mssql && cd zabbix-agent2-plugin-mssql-* && dpkg-buildpackage -uc -us

FROM ubuntu:22.04 AS ubuntu-18.04

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=ubuntu-18.04-build /tmp/zabbix/*.deb /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN cd /tmp && gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*.deb

FROM ubuntu:20.04 AS ubuntu-20.04-build

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y build-essential equivs wget
RUN wget -P /tmp https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1%2Bubuntu20.04_all.deb && dpkg -i /tmp/zabbix-release_7.0-1+ubuntu20.04_all.deb
RUN wget -P /tmp https://go.dev/dl/go1.22.4.linux-s390x.tar.gz && tar -C /usr/local -xzf /tmp/go1.22.4.linux-s390x.tar.gz
ENV PATH=PATH=$PATH:/usr/local/go/bin

RUN apt update -y
RUN mkdir /tmp/zabbix
RUN cd /tmp/zabbix && apt source zabbix && apt build-dep -y zabbix && cd zabbix-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-postgresql && cd zabbix-agent2-plugin-postgresql-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-ember-plus && cd zabbix-agent2-plugin-ember-plus-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mongodb && cd zabbix-agent2-plugin-mongodb-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mssql && cd zabbix-agent2-plugin-mssql-* && dpkg-buildpackage -uc -us

FROM ubuntu:22.04 AS ubuntu-20.04

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=ubuntu-20.04-build /tmp/zabbix/*.deb /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN cd /tmp && gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*.deb

FROM ubuntu:22.04 AS ubuntu-22.04-build

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y build-essential equivs wget
RUN wget -P /tmp https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1%2Bubuntu22.04_all.deb && dpkg -i /tmp/zabbix-release_7.0-1+ubuntu22.04_all.deb
RUN wget -P /tmp https://go.dev/dl/go1.22.4.linux-s390x.tar.gz && tar -C /usr/local -xzf /tmp/go1.22.4.linux-s390x.tar.gz
ENV PATH=PATH=$PATH:/usr/local/go/bin

RUN apt update -y
RUN mkdir /tmp/zabbix
RUN cd /tmp/zabbix && apt source zabbix && apt build-dep -y zabbix && cd zabbix-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-postgresql && cd zabbix-agent2-plugin-postgresql-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-ember-plus && cd zabbix-agent2-plugin-ember-plus-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mongodb && cd zabbix-agent2-plugin-mongodb-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mssql && cd zabbix-agent2-plugin-mssql-* && dpkg-buildpackage -uc -us

FROM ubuntu:22.04 AS ubuntu-22.04

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=ubuntu-22.04-build /tmp/zabbix/*.deb /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN cd /tmp && gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*.deb

FROM ubuntu:24.04 AS ubuntu-24.04-build

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y build-essential equivs wget
RUN wget -P /tmp https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_7.0-1%2Bubuntu24.04_all.deb && dpkg -i /tmp/zabbix-release_7.0-1+ubuntu24.04_all.deb
RUN wget -P /tmp https://go.dev/dl/go1.22.4.linux-s390x.tar.gz && tar -C /usr/local -xzf /tmp/go1.22.4.linux-s390x.tar.gz
ENV PATH=PATH=$PATH:/usr/local/go/bin

RUN apt update -y
RUN mkdir /tmp/zabbix
RUN cd /tmp/zabbix && apt source zabbix && apt build-dep -y zabbix && cd zabbix-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-postgresql && cd zabbix-agent2-plugin-postgresql-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-ember-plus && cd zabbix-agent2-plugin-ember-plus-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mongodb && cd zabbix-agent2-plugin-mongodb-* && dpkg-buildpackage -uc -us
RUN cd /tmp/zabbix && apt source zabbix-agent2-plugin-mssql && cd zabbix-agent2-plugin-mssql-* && dpkg-buildpackage -uc -us

FROM ubuntu:24.04 AS ubuntu-24.04

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=ubuntu-24.04-build /tmp/zabbix/*.deb /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN cd /tmp && gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*.deb

FROM rockylinux:9 AS rhel-9-build

RUN dnf -y install rpm-build dnf-plugins-core gcc golang
RUN dnf config-manager --set-enabled crb
RUN dnf -y builddep https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-7.0.0-release1.el9.src.rpm
RUN rpmbuild --rebuild --define='build_agent2 1' https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-7.0.0-release1.el9.src.rpm
RUN rpmbuild --rebuild https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-agent2-plugin-ember-plus-7.0.0-release1.el9.src.rpm
RUN rpmbuild --rebuild https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-agent2-plugin-mongodb-7.0.0-release1.el9.src.rpm
RUN rpmbuild --rebuild https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-agent2-plugin-mssql-7.0.0-release1.el9.src.rpm
RUN rpmbuild --rebuild https://repo.zabbix.com/zabbix/7.0/rhel/9/SRPMS/zabbix-agent2-plugin-postgresql-7.0.0-release1.el9.src.rpm

FROM ubuntu:24.04 AS rhel-9

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=rhel-9-build /root/rpmbuild/RPMS/s390x/*.rpm /tmp/zabbix/
COPY --from=rhel-9-build /root/rpmbuild/RPMS/noarch/*.rpm /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*.rpm

FROM ubuntu:24.04 AS all

ARG VERSION
ARG GITHUB_TOKEN
ARG GITHUB_REPOSITORY
ARG GITHUB_SERVER_URL

RUN apt update -y && DEBIAN_FRONTEND=noninteractive apt install -y gh ca-certificates
RUN mkdir /tmp/zabbix
COPY --from=ubuntu-18.04-build /tmp/zabbix/*.deb /tmp/zabbix/
COPY --from=ubuntu-20.04-build /tmp/zabbix/*.deb /tmp/zabbix/
COPY --from=ubuntu-22.04-build /tmp/zabbix/*.deb /tmp/zabbix/
COPY --from=ubuntu-24.04-build /tmp/zabbix/*.deb /tmp/zabbix/
COPY --from=rhel-9-build /root/rpmbuild/RPMS/s390x/*.rpm /tmp/zabbix/
COPY --from=rhel-9-build /root/rpmbuild/RPMS/noarch/*.rpm /tmp/zabbix/
RUN gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} view ${VERSION} || gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} create ${VERSION} --notes ${VERSION}
RUN cd /tmp && gh release -R ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY} upload --clobber ${VERSION} /tmp/zabbix/*
